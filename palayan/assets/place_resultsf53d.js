"use strict";function place_map(places){var map_div=document.querySelector('.rv-map');var tout=0,bubble=document.querySelector('.rv-bubble');var ICOMUL=.9;var create_marker=function(i,icon){var lat=parseFloat(places[i].getAttribute('data-lat'));var lon=parseFloat(places[i].getAttribute('data-lon'));if(i==0){lat=parseFloat(places[i].getAttribute('data-lat-over'))||lat;lon=parseFloat(places[i].getAttribute('data-lon-over'))||lon;}
var ll=new google.maps.LatLng(lat,lon);var m=null,x=450*ICOMUL,y=350*ICOMUL;if(i){y=Math.floor(Math.floor((i-1)/10)*70*ICOMUL);x=Math.floor(((i-1)%10)*50*ICOMUL);}
icon.origin=new google.maps.Point(x,y);icon.ya=y;icon.yb=y+420*ICOMUL;m=new google.maps.Marker({map:map,zIndex:(i?908:909),position:ll,icon:icon});m.addListener('click',function(){window.location.href=places[i].getAttribute('href');});m.addListener('mouseover',function(){clearTimeout(tout);var ll=proj.fromLatLngToContainerPixel(this.getPosition());var p=places[i];var out='<a href="%s">%s</a><br>Livability Score: <b>%s</b>';out=out.spf(p.getAttribute('href'),p.querySelector('strong').textContent,p.querySelector('.scr').textContent);bubble.innerHTML=out;bubble.style.left=Math.round(map_div.offsetLeft+ll.x+11)+'px';bubble.style.top=Math.round(map_div.offsetTop+ll.y-22-bubble.offsetHeight)+'px';bubble.removeAttribute('data-hide');});m.addListener('mouseout',function(){tout=setTimeout(function(){bubble.setAttribute('data-hide','');},3500);});return m;};var map,bnds,proj;var init_map=function(){map=new google.maps.Map(map_div,{zoom:14,mapTypeId:google.maps.MapTypeId.ROADMAP,scaleControl:false,zoomControl:true,scrollwheel:true,streetViewControl:true,mapTypeControl:false});bnds=new google.maps.LatLngBounds();var overlay=new google.maps.OverlayView();overlay.draw=function(){};overlay.onAdd=function(){proj=this.getProjection();};overlay.setMap(map);};var mico={url:'/images/pins-num-sprite.png',size:new google.maps.Size(30*ICOMUL,40*ICOMUL),scaledSize:new google.maps.Size(480*ICOMUL,810*ICOMUL),origin:null};var update_map=function(){google.maps.event.addListenerOnce(map,'idle',function(){var i,m,l;for(i=0,l=places.length;i<l;i++){if(places[i].getAttribute('href')){m=create_marker(i,mico);bnds.extend(m.getPosition());places[i].mrkr=m;}}
if(!bnds.isEmpty()){map.fitBounds(bnds);if(map.getZoom()>14){map.setZoom(14);}}});};return{is_init:function(){return!!map;},is_visible:function(){return!(map_div.offsetParent===null);},refresh:function(){if(!bnds.isEmpty()){map.fitBounds(bnds);}},init:init_map,update:update_map};}
function filters_menu_activate(){var active_menu=null;var activate=function(evt){var menu=evt.currentTarget.parentElement;if(active_menu&&active_menu===menu){active_menu.setAttribute('data-reveal','');active_menu=null;}
else if(active_menu&&active_menu!==menu){active_menu.setAttribute('data-reveal','');active_menu=menu;active_menu.setAttribute('data-reveal','1');}
else{active_menu=menu;active_menu.setAttribute('data-reveal','1');}};var opts=document.querySelectorAll('form.rv-filter .fltr-item-brief');for(var i=0,l=opts.length;i<l;i++){opts[i].addEventListener('click',activate);}}
function filters_panel_dis(update_obs){var pan=document.querySelector('.fltr-item.dis');var out_pri=pan.querySelector('.fltr-item-brief span:nth-child(2)');var steps=[5,10,15,20,25,50,100,200];pan.addEventListener('input',function(evt){var s=steps[evt.target.value];evt.target.previousSibling.textContent=s;});pan.addEventListener('change',function(evt){var s=steps[evt.target.value];evt.target.previousSibling.textContent=s;out_pri.textContent=s+' miles';update_obs({'dis':{'opt-dis':~~evt.target.value}});});return{init:function(values){var tgt=pan.querySelector('input[name=opt-dis]');var s=steps[values['opt-dis']];tgt.previousSibling.textContent=s;tgt.value=values['opt-dis'];out_pri.textContent=s+' miles';}};}
function filters_panel_win(update_obs){var pan=document.querySelector('.fltr-item.win');var out_pri=pan.querySelector('.fltr-item-brief span:nth-child(2)');pan.addEventListener('change',function(evt){out_pri.textContent=evt.target.options[evt.target.selectedIndex].textContent;update_obs({'win':{'opt-sel':evt.target.value,'opt-state':out_pri.textContent.toLowerCase()}});});return{init:function(values){var tgt=pan.querySelector('select');tgt.value=values['opt-sel'];out_pri.textContent=tgt.options[tgt.selectedIndex].textContent;}};}
function filters_panel_imp(update_obs){var pan=document.querySelector('.fltr-item.imp');var out_pri=pan.querySelector('.fltr-item-brief span:nth-child(2)');var ctrls=[pan.querySelector('.fltr-item-panel input[name=opt-ams]'),pan.querySelector('.fltr-item-panel input[name=opt-col]'),pan.querySelector('.fltr-item-panel input[name=opt-cri]'),pan.querySelector('.fltr-item-panel input[name=opt-edu]'),pan.querySelector('.fltr-item-panel input[name=opt-emp]'),pan.querySelector('.fltr-item-panel input[name=opt-hou]'),pan.querySelector('.fltr-item-panel input[name=opt-wea]')];var ctrls_ndx={'opt-ams':0,'opt-col':1,'opt-cri':2,'opt-edu':3,'opt-emp':4,'opt-hou':5,'opt-wea':6};var label_text=function(){if(window.filter_class){var str=window.filter_class.replace(/\-/g,' ');return str[0].toUpperCase()+str.slice(1);}
for(var i=0,l=ctrls.length;i<l;i++){if(~~ctrls[i].value){return'Custom';}}
return'Livability';};var imp_text=function(v){v=~~v+2;return['Not Important','Less Important','Moderate','Important','Very Important'][v];};pan.addEventListener('input',function(evt){var s=imp_text(evt.target.value);ctrls[ctrls_ndx[evt.target.name]].previousSibling.textContent=s;});pan.addEventListener('change',function(evt){var s=imp_text(evt.target.value);ctrls[ctrls_ndx[evt.target.name]].previousSibling.textContent=s;out_pri.textContent=label_text();var tmp={'imp':{}};tmp.imp[evt.target.name]=~~evt.target.value;update_obs(tmp);});return{init:function(values){for(var n in values){var tgt=pan.querySelector('input[name='+n+']');tgt.value=values[n];tgt.previousSibling.textContent=imp_text(values[n]);}
out_pri.textContent=label_text();}};}
function filters_panel_pop(update_obs){var pan=document.querySelector('.fltr-item.pop');var out_pri=pan.querySelector('.fltr-item-brief span:nth-child(2)');var steps=['0 - 10M','5K - 10M','0 - 10K','10K - 20K','20K - 50K','50K - 100K','100K - 500K','100K - 10M'];pan.addEventListener('input',function(evt){var s=steps[evt.target.value];evt.target.previousSibling.textContent=s;});pan.addEventListener('change',function(evt){var s=steps[evt.target.value];evt.target.previousSibling.textContent=s;out_pri.textContent=s;update_obs({'pop':{'opt-pop':~~evt.target.value}});});return{init:function(values){var tgt=pan.querySelector('input[name=opt-pop]');var s=steps[values['opt-pop']];tgt.previousSibling.textContent=s;tgt.value=values['opt-pop'];out_pri.textContent=s;}};}
function filters_panel_inc(update_obs){var pan=document.querySelector('.fltr-item.inc');var out_pri=pan.querySelector('.fltr-item-brief span:nth-child(2)');var inc_text=function(v){switch(v){case'c':return'Cities only';case'h':return'Neighborhoods only';default:return'Cities/Neighborhoods';}};pan.addEventListener('change',function(evt){out_pri.textContent=inc_text(evt.target.value);update_obs({'inc':{'opt-inc':evt.target.value}});});return{init:function(values){var tgt=pan.querySelector('input[name=opt-inc][value='+values['opt-inc']+']');tgt.checked=true;out_pri.textContent=inc_text(values['opt-inc']);}};}
function filters_panel_cos(update_obs){var pan=document.querySelector('.fltr-item.cos');var out_pri=pan.querySelector('.fltr-item-brief span:nth-child(2)');var steps_hv=['Any','0 - 150K','150K - 300K','300K - 500K','500K - 750K','750K - 1M','1M+'];var steps_mr=['Any','0 - 500','500 - 750','750 - 1000','1000 - 1400','1400 - 2000','2000+'];var sld=pan.querySelector('input[name=opt-val]');var which=function(){return pan.querySelector('input[name=opt-cos]:checked').value;};var cos_text=function(){var wv=which();if(wv!='x'){var s=wv=='h'?steps_hv[sld.value]:steps_mr[sld.value];return'$'+s;}
return'Not selected';};pan.addEventListener('input',function(evt){if(evt.target.type.toLowerCase()=='range'){var wv=which();if(wv!='x'){var s=wv=='h'?steps_hv[evt.target.value]:steps_mr[evt.target.value];evt.target.previousSibling.textContent=s;}}});pan.addEventListener('change',function(evt){if(evt.target.type.toLowerCase()=='range'){var wv=which();if(wv!='x'){var s=wv=='h'?steps_hv[evt.target.value]:steps_mr[evt.target.value];evt.target.previousSibling.textContent=s;out_pri.textContent=cos_text();update_obs({'cos':{'opt-val':~~evt.target.value}});}}
else if(evt.target.type.toLowerCase()=='radio'){out_pri.textContent=cos_text();sld.disabled=which()=='x';var wv=which();if(wv!='x'){var tgt=pan.querySelector('input[name=opt-val]');var s=which()=='h'?steps_hv[tgt.value]:steps_mr[tgt.value];tgt.previousSibling.textContent=s;}
update_obs({'cos':{'opt-cos':evt.target.value}});}});return{init:function(values){var tgt=pan.querySelector('input[name=opt-cos][value='+values['opt-cos']+']');tgt.checked=true;var wv=which();sld.disabled=wv=='x';pan.querySelector('input[name=opt-val]').value=values['opt-val'];out_pri.textContent=cos_text();tgt=pan.querySelector('input[name=opt-val]');var s=wv=='h'?steps_hv[tgt.value]:steps_mr[tgt.value];tgt.previousSibling.textContent=s;}};}
function filters_panel_setup(){var opts=JSON.parse(cookie(window.search_cname));if(window.location.pathname.indexOf('/best-places/',0)===0){opts.win['opt-sel']=(window.boundary_name||'us').toLowerCase();if(window.filter_class){opts.imp=window.filter_override;}
var update_obs=function(opt){var pri_key=Object.keys(opt)[0];for(var sub_key in opt[pri_key]){opts[pri_key][sub_key]=opt[pri_key][sub_key];}
cookie(window.search_cname,JSON.stringify(opts),{'path':'/best-places/'});var uri=window.location.pathname;if(pri_key=='imp'){if(window.filter_class){uri+='../';}}
else if(pri_key=='win'){uri='/best-places/'+opt.win['opt-state'].enc()+'/';if(window.filter_class){uri+=window.filter_class.enc()+'/';}}
window.location.href=uri;};}
else{var update_obs=function(opt){var pri_key=Object.keys(opt)[0];for(var sub_key in opt[pri_key]){opts[pri_key][sub_key]=opt[pri_key][sub_key];}
cookie(window.search_cname,JSON.stringify(opts),{'path':'/'});window.location.reload();};}
filters_panel_dis(update_obs).init(opts.dis);filters_panel_win(update_obs).init(opts.win);filters_panel_imp(update_obs).init(opts.imp);filters_panel_pop(update_obs).init(opts.pop);filters_panel_inc(update_obs).init(opts.inc);filters_panel_cos(update_obs).init(opts.cos);}
function vh_fix(force){var bd=document.querySelector('body');var wh=window.innerHeight;var bh=bd.offsetHeight;var fix=function(evt){bd.style.height=window.innerHeight+'px';bd.style.width=window.innerWidth+'px';};if(force){fix();}
if(wh!==bh){}
var is_mobile_safari_7=!!navigator.userAgent.match(/i(Pad|Phone|Pod).+(Version\/7\.\d+ Mobile)/i);if(is_mobile_safari_7){window.addEventListener('orientationchange',fix,true);fix();}};function update_zw_btns(places){var i,l,a,u;for(i=0,l=places.length;i<l;i++){a=places[i].nextElementSibling.firstElementChild;if(a){u=places[i].querySelector('strong').textContent.split(', ').join('_');u=fix_saint(u);u=r47_paths.re_search.r47()+u.enc()+'/';u+='?cid=prt_areavibes_results';a.setAttribute('href',u);a.setAttribute('target','_blankaff');a.addEventListener('click',function(evt){zw_out_log('res');});}}}
doc_ready(function(){if(!document.querySelector('body.place-results'))return;vh_fix();filters_menu_activate();filters_panel_setup();var places=document.querySelectorAll('.tile-listings .rv-list > a');var pmap=place_map(places);update_zw_btns(places);if(pmap.is_visible()){pmap.init();pmap.update();}
var pm_resize=function(){if(!pmap.is_init()&&pmap.is_visible()){pmap.init();pmap.update();}
else if(pmap.is_init()&&pmap.is_visible()){pmap.refresh();}};window.addEventListener('resize',debounce(pm_resize,750));var upd_icon=function(mrkr,state){if(mrkr){var ico=mrkr.getIcon();ico.origin.y=(state?ico.yb:ico.ya);mrkr.setZIndex(mrkr.getZIndex()+(state?2:-2));}};for(var i=0,l=places.length;i<l;i++){places[i].addEventListener('mouseenter',function(evt){if(evt.target.nodeName.toLowerCase()=='a'){upd_icon(evt.target.mrkr,1);}
evt.preventDefault();});places[i].addEventListener('mouseleave',function(evt){if(evt.target.nodeName.toLowerCase()=='a'){upd_icon(evt.target.mrkr,0);}
evt.preventDefault();});}});