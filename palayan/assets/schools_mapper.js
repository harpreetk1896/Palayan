"use strict";function schools_mapper(div){if(!div)return;var map_div=div.querySelector('.school-map .school-map-map');var bub_div=div.querySelector('.school-map .school-map-bubble');var results=div.querySelectorAll('.school-results ul li');var map,bnds,proj;var init_map=function(){map=new google.maps.Map(map_div,{zoom:14,mapTypeId:google.maps.MapTypeId.ROADMAP,scaleControl:false,zoomControl:true,scrollwheel:true,streetViewControl:true,mapTypeControl:false});bnds=new google.maps.LatLngBounds();var overlay=new google.maps.OverlayView();overlay.draw=function(){};overlay.onAdd=function(){proj=this.getProjection();};overlay.setMap(map);var lat=parseFloat(map_div.parentNode.getAttribute('data-lat'));var lon=parseFloat(map_div.parentNode.getAttribute('data-lon'));map.setCenter({'lat':lat,'lng':lon});};init_map();var tout;var mico_lo='http://maps.google.com/mapfiles/kml/pal2/icon10.png';var mico_hi='http://maps.google.com/mapfiles/kml/pal2/icon2.png';var create_marker=function(i){var lat=parseFloat(results[i].getAttribute('data-lat'));var lon=parseFloat(results[i].getAttribute('data-lon'));var mrkr=new google.maps.Marker({map:map,icon:mico_lo,position:new google.maps.LatLng(lat,lon)});mrkr.addListener('mouseover',function(){clearTimeout(tout);var ll=proj.fromLatLngToContainerPixel(this.getPosition());bub_div.innerHTML=results[i].innerHTML;bub_div.style.left=Math.round(ll.x+24)+'px';bub_div.style.top=Math.round(ll.y-(bub_div.offsetHeight/2))+'px';bub_div.removeAttribute('data-hide');this.setIcon(mico_hi);});mrkr.addListener('mouseout',function(){this.setIcon(mico_lo);tout=setTimeout(function(){bub_div.setAttribute('data-hide','');},2500);});mrkr.addListener('click',function(){results[i].parentNode.scrollTop=results[i].offsetTop-results[i].parentNode.offsetTop;results[i].className='sel';setTimeout(function(){results[i].className='';},1000);});results[i].mrkr=mrkr;};var res_mrkr_int=function(i){results[i].addEventListener('mouseover',function(evt){results[i].mrkr.setIcon(mico_hi);});results[i].addEventListener('mouseout',function(evt){results[i].mrkr.setIcon(mico_lo);});results[i].addEventListener('click',function(evt){map.setCenter(results[i].mrkr.getPosition());});};var i=0,l=results.length;for(;l>0;l--,i++){create_marker(i);res_mrkr_int(i);}
var sld_num=document.getElementById('flt-score-num');var cnt_txt=document.getElementById('school-res-cnt');cnt_txt.textContent=results.length;var filters=function(frm){var fmask=15;frm.addEventListener('click',function(evt){if(evt.target.nodeName.toLowerCase()=='input'&&evt.target.name=='flt-grade'){var cnt=0;if(evt.target.checked){fmask|=parseInt(evt.target.value,10);}
else{fmask&=~parseInt(evt.target.value,10);}
[].filter.call(results,function(val,ndx){var pmask=parseInt(results[ndx].getAttribute('data-pemh'),10);if(pmask&fmask){results[ndx].mrkr.setVisible(true);results[ndx].style.display='';cnt++;}
else{results[ndx].mrkr.setVisible(false);results[ndx].style.display='none';}});cnt_txt.textContent=cnt;}});frm.addEventListener('input',function(evt){if(evt.target.nodeName.toLowerCase()=='input'&&evt.target.name=='flt-score'){sld_num.textContent=evt.target.value;}});frm.addEventListener('change',function(evt){if(evt.target.nodeName.toLowerCase()=='input'&&evt.target.name=='flt-score'){var cnt=0,min_scr=evt.target.value;[].filter.call(results,function(val,ndx){var sc=parseInt(results[ndx].getAttribute('data-scr')||0,10);if(sc>=min_scr){results[ndx].mrkr.setVisible(true);results[ndx].style.display='';cnt++;}
else{results[ndx].mrkr.setVisible(false);results[ndx].style.display='none';}});cnt_txt.textContent=cnt;sld_num.textContent=min_scr;}});};var sorters=function(frm){var res_sort=[].slice.call(results);var sort_name=function(a,b){var ac=parseInt(a.getAttribute('data-ndx'),10);var bc=parseInt(b.getAttribute('data-ndx'),10);return ac-bc;};var sort_score=function(a,b){var ac=parseFloat(a.getAttribute('data-scr')||0);var bc=parseFloat(b.getAttribute('data-scr')||0);return bc-ac;};var sort_ratio=function(a,b){var ac=parseFloat(a.getAttribute('data-str')||0);var bc=parseFloat(b.getAttribute('data-str')||0);return ac-bc;};frm.addEventListener('change',function(evt){switch(evt.target.value){case'N':res_sort.sort(sort_name);break;case'S':res_sort.sort(sort_score);break;case'R':res_sort.sort(sort_ratio);break;default:return;}
var list_node=div.querySelector('.school-results ul');while(list_node.firstChild){list_node.removeChild(list_node.firstChild);}
var i=0,l=res_sort.length;for(;l;i++,l--){list_node.appendChild(res_sort[i]);}});};var frm=div.querySelector('.school-results form');filters(frm);sorters(frm);(function(frm){var sel=frm.querySelector('select');sel.selectedIndex=0;var evt=document.createEvent('HTMLEvents');evt.initEvent('change',true,true);sel.children[0].dispatchEvent(evt);})(frm);}